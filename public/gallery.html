<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Photo Gallery</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-image: url(./images/flower5.jpg);
        background-repeat: no-repeat;
        background-size: cover;
        color: #333;
        margin: 0;
        padding: 20px;
      }
      h2 {
        text-align: center;
        color: #fffafc;
        margin-bottom: 20px;
      }
      form {
        text-align: center;
        margin-bottom: 30px;
      }
      input[type="file"],
      input[type="text"] {
        padding: 10px;
        border: 2px solid #e75480;
        border-radius: 8px;
        background: white;
        margin: 5px;
        cursor: pointer;
      }

      button {
        background: #e75480;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        margin-left: 10px;
        font-weight: bold;
        transition: 0.3s;
      }
      button:hover {
        background: #ff6fa1;
        transform: scale(1.05);
      }
      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        justify-items: center;
      }
      .photo-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: 0.3s;
        width: 250px;
        text-align: center;
      }
      .photo-card .img-container {
        width: 100%;
        height: 250px;
        overflow: hidden;
      }
      .photo-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        border-bottom: 3px solid #ffe4ec;
        cursor: pointer;
        transition: 0.3s;
      }
      .photo-card img:hover {
        filter: brightness(1.1);
        transform: scale(1.05);
      }
      .photo-actions {
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 10px;
        border-top: 1px solid #eee;
      }
      .action-btn {
        font-size: 18px;
        cursor: pointer;
        transition: 0.3s;
        color: #aaa;
      }
      .action-btn:hover {
        transform: scale(1.2);
      }
      .like-btn.liked {
        color: #e75480;
      }
      .caption {
        font-size: 14px;
        color: #555;
        padding: 0 12px 8px;
        text-align: left;
      }
      .comment-section {
        padding: 0 12px 12px;
        display: none;
        text-align: left;
      }
      .comment-section input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 6px;
      }
      .comment {
        font-size: 13px;
        margin: 4px 0;
        color: #333;
      }
      .lightbox {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .lightbox img {
        max-width: 90%;
        max-height: 80%;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
      }
      .lightbox .close-btn {
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 30px;
        color: white;
        cursor: pointer;
        font-weight: bold;
      }
      .lightbox .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 40px;
        color: white;
        cursor: pointer;
        font-weight: bold;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 50%;
      }
      .lightbox .prev-btn {
        left: 20px;
      }
      .lightbox .next-btn {
        right: 20px;
      }
      .lightbox .desc {
        color: #fff;
        margin-top: 15px;
        font-size: 16px;
      }
      nav {
        background: transparent;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
      }
      nav h1 {
        margin: 0;
        font-size: 20px;
      }
      nav a {
        background: white;
        color: #e75480;
        text-decoration: none;
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: bold;
        transition: 0.3s;
      }
      nav a:hover {
        background: #ff6fa1;
        color: white;
      }
      .bubbles {
        position: fixed;
        width: 100%;
        height: 100%;
        overflow: hidden;
        top: 0;
        left: 0;
        z-index: -1; /* content ke peeche rahe */
      }

      .bubble {
        position: absolute;
        bottom: -100px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        animation: rise 10s infinite ease-in;
      }

      @keyframes rise {
        0% {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
        100% {
          transform: translateY(-120vh) scale(0.5);
          opacity: 0;
        }
      }
      .bubble {
        position: absolute;
        bottom: -100px;
        border-radius: 50%;
        animation: rise 10s infinite ease-in;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 0, 150, 0.6),
          rgba(0, 200, 255, 0.4)
        );
        box-shadow: 0 0 15px rgba(255, 0, 200, 0.6);
      }
    </style>
  </head>
  <body>
    <nav>
      <h1>ðŸ“¸ My SmartGallery</h1>
      <a href="index.html">â¬… Back to Home</a>
    </nav>
    <div class="bubbles"></div>
    <h2>Upload a Photo</h2>
    <form id="uploadForm">
      <input type="file" name="photo" id="photo" required />
      <input
        type="text"
        name="description"
        id="description"
        placeholder="Write a description..."
      />
      <button type="submit">Upload</button>
    </form>

    <h2></h2>
    <div class="gallery" id="gallery"></div>

    <!-- Fullscreen Lightbox -->
    <div class="lightbox" id="lightbox">
      <span class="close-btn" id="closeLightbox">&times;</span>
      <span class="nav-btn prev-btn" id="prevBtn">&#10094;</span>
      <img id="lightboxImg" src="" alt="Full View" />
      <span class="nav-btn next-btn" id="nextBtn">&#10095;</span>
      <div class="desc" id="lightboxDesc"></div>
    </div>

    <script>
      const uploadForm = document.getElementById("uploadForm");
      const gallery = document.getElementById("gallery");
      const lightbox = document.getElementById("lightbox");
      const lightboxImg = document.getElementById("lightboxImg");
      const lightboxDesc = document.getElementById("lightboxDesc");
      const closeLightbox = document.getElementById("closeLightbox");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      let photos = [];
      let currentIndex = 0;

      async function loadPhotos() {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Please login first!");
          window.location.href = "login.html";
          return;
        }

        const res = await fetch("http://localhost:5000/photos", {
          headers: { Authorization: token },
        });
        if (res.status === 401 || res.status === 403) {
          alert("Session expired!");
          window.location.href = "login.html";
          return;
        }
        photos = await res.json();

        gallery.innerHTML = "";
        photos.forEach((photo, index) => {
          const card = document.createElement("div");
          card.classList.add("photo-card");

          const imgContainer = document.createElement("div");
          imgContainer.classList.add("img-container");
          const img = document.createElement("img");
          img.src = photo.url;
          img.addEventListener("click", () => openLightbox(index));
          imgContainer.appendChild(img);

          const actions = document.createElement("div");
          actions.classList.add("photo-actions");

          // Like
          const likeBtn = document.createElement("span");
          likeBtn.innerHTML = `â¤ï¸ ${photo.likes ? photo.likes.length : 0}`;
          likeBtn.classList.add("action-btn", "like-btn");
          likeBtn.addEventListener("click", async () => {
            const res = await fetch(
              `http://localhost:5000/photos/${photo._id}/like`,
              { method: "POST", headers: { Authorization: token } }
            );
            const data = await res.json();
            if (data.success) {
              likeBtn.innerHTML = `â¤ï¸ ${data.likes}`;
            }
          });

          // Comment button
          const commentBtn = document.createElement("span");
          commentBtn.innerHTML = "ðŸ’¬";
          commentBtn.classList.add("action-btn");

          // Download
          const downloadBtn = document.createElement("a");
          downloadBtn.innerHTML = "â¬‡ï¸";
          downloadBtn.classList.add("action-btn");
          downloadBtn.href = photo.url;
          downloadBtn.download = "photo.jpg";

          // Delete
          const deleteBtn = document.createElement("span");
          deleteBtn.innerHTML = "ðŸ—‘ï¸";
          deleteBtn.classList.add("action-btn");
          deleteBtn.addEventListener("click", async () => {
            if (confirm("Are you sure you want to delete this photo?")) {
              const res = await fetch(
                `http://localhost:5000/photos/${photo._id}`,
                { method: "DELETE", headers: { Authorization: token } }
              );
              const data = await res.json();
              if (data.success) {
                loadPhotos();
              }
            }
          });

          actions.appendChild(likeBtn);
          actions.appendChild(commentBtn);
          actions.appendChild(downloadBtn);
          actions.appendChild(deleteBtn);

          // Caption me uploader ka naam + description
          const caption = document.createElement("div");
          caption.classList.add("caption");
          caption.innerText =
            (photo.user?.username
              ? `Uploaded by ${photo.user.username} - `
              : "") + (photo.description || "No description");

          // Comment section
          const commentSection = document.createElement("div");
          commentSection.classList.add("comment-section");
          const commentInput = document.createElement("input");
          commentInput.placeholder = "Write a comment...";
          const commentsList = document.createElement("div");

          // Existing comments (with username)
          if (photo.comments) {
            photo.comments.forEach((c) => {
              const com = document.createElement("div");
              com.classList.add("comment");
              com.innerText =
                (c.user?.username ? `${c.user.username}: ` : "") + c.text;
              commentsList.appendChild(com);
            });
          }

          commentInput.addEventListener("keypress", async (e) => {
            if (e.key === "Enter" && commentInput.value.trim() !== "") {
              const res = await fetch(
                `http://localhost:5000/photos/${photo._id}/comment`,
                {
                  method: "POST",
                  headers: {
                    Authorization: token,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ text: commentInput.value }),
                }
              );
              const data = await res.json();
              if (data.success) {
                loadPhotos();
              }
            }
          });

          commentBtn.addEventListener("click", () => {
            commentSection.style.display =
              commentSection.style.display === "block" ? "none" : "block";
          });

          commentSection.appendChild(commentInput);
          commentSection.appendChild(commentsList);

          card.appendChild(imgContainer);
          card.appendChild(actions);
          card.appendChild(caption);
          card.appendChild(commentSection);

          gallery.appendChild(card);
        });
      }

      function openLightbox(index) {
        currentIndex = index;
        lightbox.style.display = "flex";
        lightboxImg.src = photos[index].url;
        lightboxDesc.innerText =
          (photos[index].user?.username
            ? `Uploaded by ${photos[index].user.username} - `
            : "") + (photos[index].description || "No description");
      }

      closeLightbox.addEventListener("click", () => {
        lightbox.style.display = "none";
        lightboxImg.src = "";
      });
      prevBtn.addEventListener("click", () => {
        currentIndex = (currentIndex - 1 + photos.length) % photos.length;
        openLightbox(currentIndex);
      });
      nextBtn.addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % photos.length;
        openLightbox(currentIndex);
      });
      lightbox.addEventListener("click", (e) => {
        if (e.target === lightbox) {
          lightbox.style.display = "none";
        }
      });

      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Please login first!");
          window.location.href = "login.html";
          return;
        }
        const formData = new FormData();
        formData.append("photo", document.getElementById("photo").files[0]);
        formData.append(
          "description",
          document.getElementById("description").value
        );

        const res = await fetch("http://localhost:5000/upload", {
          method: "POST",
          body: formData,
          headers: { Authorization: token },
        });
        const data = await res.json();
        if (data.success) {
          loadPhotos();
          document.getElementById("description").value = "";
        } else {
          alert("Upload failed!");
        }
      });
      // Bubble container
      const bubbleContainer = document.querySelector(".bubbles");

      // Different gradients for multicolor bubbles
      const gradients = [
        "radial-gradient(circle at 30% 30%, rgba(255,0,150,0.6), rgba(0,200,255,0.4))",
        "radial-gradient(circle at 30% 30%, rgba(0,255,150,0.6), rgba(0,100,255,0.4))",
        "radial-gradient(circle at 30% 30%, rgba(255,200,0,0.6), rgba(255,0,100,0.4))",
        "radial-gradient(circle at 30% 30%, rgba(150,0,255,0.6), rgba(0,255,200,0.4))",
      ];

      // Function to create one bubble
      function createBubble() {
        const bubble = document.createElement("div");
        bubble.classList.add("bubble");

        // Random size (20px - 60px)
        let size = Math.random() * 40 + 20;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;

        // Random horizontal position
        bubble.style.left = Math.random() * window.innerWidth + "px";

        // Random animation duration (5s - 10s)
        bubble.style.animationDuration = Math.random() * 5 + 5 + "s";
        // bubble.style.animationDelay = Math.random() * 3 + "s";

        // Random gradient color
        bubble.style.background =
          gradients[Math.floor(Math.random() * gradients.length)];

        // Add to container
        bubbleContainer.appendChild(bubble);

        // Remove after animation ends
        setTimeout(() => bubble.remove(), 10000);
      }

      // Har 500ms me ek bubble create hoga
      setInterval(createBubble, 500);

      loadPhotos();
    </script>
  </body>
</html>
